<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibrant Modern Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the calculator */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Removes blue tap highlight on mobile */
            transition: background-color 0.5s ease; /* Smooth transition for background theme change */
            overflow: hidden; /* Hide overflow from particles */
            position: relative; /* For particle positioning */
            /* New: Background gradient animation */
            background-size: 200% 200%;
            animation: gradientMove 15s ease infinite alternate;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        
        /* Particle Background Container */
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1; /* Send to background */
        }

        /* Dark Theme - Default */
        .theme-dark {
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d); /* Deeper dark gradient */
        }
        .theme-dark .calculator-body {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            box-shadow: 20px 20px 60px #0a0a0a, -20px -20px 60px #404040; /* Stronger shadow contrast */
        }
        .theme-dark .calculator-screen {
            background-color: rgba(0, 0, 0, 0.4); /* Slightly darker for contrast */
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .theme-dark .btn {
            box-shadow: 5px 5px 10px #1e1e1e, -5px -5px 10px #383838;
            transition: all 0.08s ease-out; /* Faster button transition */
        }
        .theme-dark .btn:active {
            transform: scale(0.95) translateY(1px); /* Added translateY */
            box-shadow: inset 3px 3px 8px #1e1e1e, inset -3px -3px 8px #383838; /* Softer inset shadow */
        }
        .theme-dark .btn-operator {
            background-color: #ff9500; /* Original orange */
            color: white;
        }
        .theme-dark .btn-action {
            background-color: #555555; /* Darker grey for action buttons */
            color: white;
        }
        .theme-dark .btn-number {
            background-color: #333333;
            color: white;
        }
        .theme-dark .btn-scientific { /* New style for scientific buttons */
            background-color: #007bff; /* Blue for scientific functions */
            color: white;
        }
        .theme-dark #display {
            color: #e0e0e0; /* Slightly off-white for display */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.4); /* Enhanced glow */
        }
        .theme-dark #history {
            color: #a0a0a0; /* Lighter grey for history */
        }
        /* New: Active operator style */
        .theme-dark .btn-operator.active-operator {
            background-color: #e08000; /* Slightly darker active orange */
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(255, 149, 0, 0.5), inset 2px 2px 5px rgba(0,0,0,0.3);
        }


        /* Light Theme */
        .theme-light {
            background: linear-gradient(135deg, #f0f2f5, #e0e2e5); /* Soft light gradient */
        }
        .theme-light .calculator-body {
            background: linear-gradient(145deg, #e6e8ec, #ffffff);
            box-shadow: 20px 20px 60px #c7ccd3, -20px -20px 60px #ffffff; /* Adjusted shadow */
        }
        .theme-light .calculator-screen {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        .theme-light .btn {
            box-shadow: 5px 5px 10px #c0c2c5, -5px -5px 10px #ffffff;
            transition: all 0.08s ease-out; /* Faster button transition */
        }
        .theme-light .btn:active {
            transform: scale(0.95) translateY(1px);
            box-shadow: inset 3px 3px 8px #c0c2c5, inset -3px -3px 8px #ffffff;
        }
        .theme-light .btn-operator {
            background-color: #1a73e8; /* Google Blue for operators */
            color: white;
        }
        .theme-light .btn-action {
            background-color: #d0d3d8;
            color: #333333;
        }
        .theme-light .btn-number {
            background-color: #eeeeee;
            color: #333333;
        }
        .theme-light .btn-scientific { /* New style for scientific buttons */
            background-color: #28a745; /* Green for scientific functions */
            color: white;
        }
        .theme-light #display {
            color: #333333;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }
        .theme-light #history {
            color: #666666;
        }
        /* New: Active operator style */
        .theme-light .btn-operator.active-operator {
            background-color: #1660d2; /* Slightly darker active blue */
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(26, 115, 232, 0.3), inset 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* Aqua Theme */
        .theme-aqua {
            background: linear-gradient(135deg, #1f2a38, #151e29); /* Deeper aqua gradient */
        }
        .theme-aqua .calculator-body {
            background: linear-gradient(145deg, #2b3b4f, #18202d);
            box-shadow: 20px 20px 60px #10161d, -20px -20px 60px #304157; /* Adjusted shadow */
        }
        .theme-aqua .calculator-screen {
            background-color: rgba(26, 40, 50, 0.6);
            border: 1px solid rgba(135, 206, 235, 0.25);
        }
        .theme-aqua .btn {
            box-shadow: 5px 5px 10px #141b24, -5px -5px 10px #2a394c;
            transition: all 0.08s ease-out; /* Faster button transition */
        }
        .theme-aqua .btn:active {
            transform: scale(0.95) translateY(1px);
            box-shadow: inset 3px 3px 8px #141b24, inset -3px -3px 8px #2a394c;
        }
        .theme-aqua .btn-operator {
            background-color: #00bcd4; /* Cyan/Turquoise */
            color: white;
        }
        .theme-aqua .btn-action {
            background-color: #3f51b5; /* Indigo */
            color: white;
        }
        .theme-aqua .btn-number {
            background-color: #263238; /* Darker grey-blue */
            color: white;
        }
        .theme-aqua .btn-scientific { /* New style for scientific buttons */
            background-color: #9c27b0; /* Purple for scientific functions */
            color: white;
        }
        .theme-aqua #display {
            color: #e0f2f7;
            text-shadow: 0 0 10px rgba(0, 220, 255, 0.5); /* Enhanced glow */
            font-family: 'Orbitron', sans-serif; /* More futuristic font */
        }
        .theme-aqua #history {
            color: #a7d9ee;
            font-family: 'Orbitron', sans-serif;
        }
        /* New: Active operator style */
        .theme-aqua .btn-operator.active-operator {
            background-color: #00a8bb; /* Slightly darker active cyan */
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.5), inset 2px 2px 5px rgba(0,0,0,0.3);
        }
        /* New: Copy button style */
        .copy-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .copy-btn:hover {
            opacity: 1;
        }

        /* Animation for result display */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        /* Screen glow animation on calculation */
        @keyframes screen-glow {
            0% { box-shadow: 0 0 0px rgba(0,0,0,0); }
            50% { box-shadow: 0 0 20px rgba(0, 220, 255, 0.7); } /* More intense glow */
            100% { box-shadow: 0 0 0px rgba(0,0,0,0); }
        }
        .theme-dark .screen-glow { animation: screen-glow 0.8s ease-out; border-color: rgba(0, 220, 255, 0.7); }
        .theme-light .screen-glow { animation: screen-glow 0.8s ease-out; box-shadow: 0 0 20px rgba(0, 100, 255, 0.4); border-color: rgba(0, 100, 255, 0.3); }
        .theme-aqua .screen-glow { animation: screen-glow 0.8s ease-out; box-shadow: 0 0 20px rgba(0, 220, 255, 0.7); border-color: rgba(0, 220, 255, 0.7); }
        
        /* New: Subtle screen glow on button press */
        @keyframes subtle-glow {
            0% { box-shadow: 0 0 0px rgba(0,0,0,0); }
            50% { box-shadow: 0 0 5px currentColor; } /* Glow using current theme color */
            100% { box-shadow: 0 0 0px rgba(0,0,0,0); }
        }
        .screen-subtle-glow {
            animation: subtle-glow 0.2s ease-out;
        }

        /* New: Error animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Theme Switcher Styles */
        .theme-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .theme-switcher button {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .theme-switcher button:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
        }
        .theme-switcher button.active {
            transform: scale(1.05);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .theme-switcher .dark-btn { background-color: #333; color: white; }
        .theme-switcher .light-btn { background-color: #eee; color: #333; }
        .theme-switcher .aqua-btn { background-color: #00bcd4; color: white; }

        /* Adjust calculator body width for scientific buttons */
        .calculator-body {
            max-width: 480px; /* Increased max-width to accommodate new column */
            position: relative; /* Ensure it stays above particles */
            z-index: 1; /* Bring calculator body to front */
        }
        /* Adjust grid for scientific buttons */
        .grid-scientific {
            grid-template-columns: repeat(5, minmax(0, 1fr)); /* 5 columns for scientific mode */
        }

        /* Dynamic font sizing for display */
        .text-fit-sm { font-size: 2.5rem; } /* ~40px */
        .text-fit-md { font-size: 3rem; } /* ~48px */
        .text-fit-lg { font-size: 3.5rem; } /* ~56px (original) */

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .calculator-body {
                max-width: 95%; /* Adjust for smaller screens */
                padding: 1rem;
            }
            .calculator-screen {
                height: 100px;
            }
            #display {
                font-size: 3rem; /* Smaller on very small screens */
            }
            #history {
                font-size: 1rem;
            }
            .btn {
                height: 16vw; /* Make buttons responsive to width */
                font-size: 1.5rem;
            }
            .btn-scientific {
                font-size: 1rem;
            }
            .text-fit-sm { font-size: 2rem; }
            .text-fit-md { font-size: 2.5rem; }
            .text-fit-lg { font-size: 3rem; }
            .theme-switcher {
                top: 10px;
                right: 10px;
                gap: 5px;
            }
            .theme-switcher button {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="theme-dark flex items-center justify-center min-h-screen">

    <div id="particles-js"></div>

    <div class="theme-switcher">
        <button class="dark-btn active" onclick="setTheme('dark')">Dark</button>
        <button class="light-btn" onclick="setTheme('light')">Light</button>
        <button class="aqua-btn" onclick="setTheme('aqua')">Aqua</button>
    </div>

    <div class="calculator-body w-full mx-auto rounded-3xl p-6 space-y-6">
        
        <div id="screen-container" class="calculator-screen w-full h-28 rounded-2xl flex flex-col justify-end items-end p-5 overflow-hidden relative">
            <div id="history" class="text-gray-400 text-xl font-light h-1/3 truncate w-full"></div>
            <div id="display" class="text-white text-5xl font-medium w-full text-right truncate h-2/3">0</div>
            <button id="copy-btn" class="copy-btn absolute top-3 left-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 1 1 7.5 0v1.5a3.75 3.75 0 0 1-7.5 0V6.75ZM15.75 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75ZM18.75 9.75a.75.75 0 0 0-.75.75V15h-1.5V9.75a.75.75 0 0 0-1.5 0V15h-1.5V9.75a.75.75 0 0 0-1.5 0V15h-1.5V9.75a.75.75 0 0 0-1.5 0V15h-1.5V9.75a.75.75 0 0 0-1.5 0V15H5.25v-5.25a.75.75 0 0 0-.75-.75.75.75 0 0 0-.75.75V15A2.25 2.25 0 0 0 6 17.25h12A2.25 2.25 0 0 0 20.25 15V9.75a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd" />
                </svg>
                <span id="copy-text">Copy</span>
            </button>
        </div>

        <div class="grid grid-cols-5 gap-4"> 
            <button onclick="performScientific('sin')" class="btn btn-scientific text-lg h-20 rounded-2xl">sin</button>
            <button onclick="performScientific('cos')" class="btn btn-scientific text-lg h-20 rounded-2xl">cos</button>
            <button onclick="performScientific('tan')" class="btn btn-scientific text-lg h-20 rounded-2xl">tan</button>
            <button onclick="performScientific('sqrt')" class="btn btn-scientific text-xl h-20 rounded-2xl">√</button>
            <button onclick="performScientific('pi')" class="btn btn-scientific text-xl h-20 rounded-2xl">π</button>

            <button onclick="clearDisplay()" class="btn btn-action text-2xl h-20 rounded-2xl">C</button>
            <button onclick="deleteLast()" class="btn btn-action text-2xl h-20 rounded-2xl">DEL</button>
            <button onclick="appendOperator('%')" class="btn btn-action text-2xl h-20 rounded-2xl">%</button>
            <button onclick="appendOperator('/')" class="btn btn-operator text-3xl h-20 rounded-2xl">÷</button>
            <button onclick="performScientific('pow2')" class="btn btn-scientific text-xl h-20 rounded-2xl">x²</button>

            <button onclick="appendNumber('7')" class="btn btn-number text-3xl h-20 rounded-2xl">7</button>
            <button onclick="appendNumber('8')" class="btn btn-number text-3xl h-20 rounded-2xl">8</button>
            <button onclick="appendNumber('9')" class="btn btn-number text-3xl h-20 rounded-2xl">9</button>
            <button onclick="appendOperator('*')" class="btn btn-operator text-3xl h-20 rounded-2xl">×</button>
            <button onclick="performScientific('log')" class="btn btn-scientific text-lg h-20 rounded-2xl">log</button>

            <button onclick="appendNumber('4')" class="btn btn-number text-3xl h-20 rounded-2xl">4</button>
            <button onclick="appendNumber('5')" class="btn btn-number text-3xl h-20 rounded-2xl">5</button>
            <button onclick="appendNumber('6')" class="btn btn-number text-3xl h-20 rounded-2xl">6</button>
            <button onclick="appendOperator('-')" class="btn btn-operator text-3xl h-20 rounded-2xl">−</button>
            <button onclick="performScientific('exp')" class="btn btn-scientific text-lg h-20 rounded-2xl">eˣ</button>

            <button onclick="appendNumber('1')" class="btn btn-number text-3xl h-20 rounded-2xl">1</button>
            <button onclick="appendNumber('2')" class="btn btn-number text-3xl h-20 rounded-2xl">2</button>
            <button onclick="appendNumber('3')" class="btn btn-number text-3xl h-20 rounded-2xl">3</button>
            <button onclick="appendOperator('+')" class="btn btn-operator text-3xl h-20 rounded-2xl">+</button>
            <button onclick="performScientific('pow')" class="btn btn-scientific text-xl h-20 rounded-2xl">xʸ</button>

            <button onclick="appendNumber('0')" class="btn btn-number col-span-2 text-3xl h-20 rounded-2xl">0</button>
            <button onclick="appendNumber('.')" class="btn btn-number text-3xl h-20 rounded-2xl">.</button>
            <button onclick="calculateResult()" class="btn btn-operator text-3xl h-20 rounded-2xl">=</button>
            <button onclick="performScientific('fact')" class="btn btn-scientific text-xl h-20 rounded-2xl">n!</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // DOM Elements
        const display = document.getElementById('display');
        const historyDisplay = document.getElementById('history');
        const screenContainer = document.getElementById('screen-container');
        const body = document.body;
        const copyBtn = document.getElementById('copy-btn');
        const copyText = document.getElementById('copy-text');

        // Calculator State
        let currentInput = '0';
        let operator = '';
        let previousInput = '';
        let shouldResetDisplay = false;
        let isScientificMode = true; // Added to manage potential mode switching if you add a toggle

        // --- Particles.js Initialization ---
        particlesJS('particles-js', {
            "particles": {
                "number": {
                    "value": 80,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#ffffff"
                },
                "shape": {
                    "type": "circle",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 5
                    },
                    "image": {
                        "src": "img/github.svg",
                        "width": 100,
                        "height": 100
                    }
                },
                "opacity": {
                    "value": 0.5,
                    "random": false,
                    "anim": {
                        "enable": false,
                        "speed": 1,
                        "opacity_min": 0.1,
                        "sync": false
                    }
                },
                "size": {
                    "value": 3,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 0.1,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#ffffff",
                    "opacity": 0.4,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 6,
                    "direction": "none",
                    "random": false,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true,
                        "mode": "grab"
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "push"
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 140,
                        "line_linked": {
                            "opacity": 1
                        }
                    },
                    "bubble": {
                        "distance": 400,
                        "size": 40,
                        "duration": 2,
                        "opacity": 8,
                        "speed": 3
                    },
                    "repulse": {
                        "distance": 200,
                        "duration": 0.4
                    },
                    "push": {
                        "particles_nb": 4
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        });


        // --- Theme Management ---
        function setTheme(themeName) {
            body.className = `theme-${themeName} flex items-center justify-center min-h-screen`;
            // Update active state of buttons
            document.querySelectorAll('.theme-switcher button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.theme-switcher .${themeName}-btn`).classList.add('active');

            // Adjust font for Aqua theme
            if (themeName === 'aqua') {
                display.style.fontFamily = 'Orbitron, sans-serif';
                historyDisplay.style.fontFamily = 'Orbitron, sans-serif';
                // Adjust particle color for aqua theme
                if (window.pJSDom && window.pJSDom[0]) {
                    window.pJSDom[0].pJS.particles.color.value = "#a7d9ee"; // Light blue for aqua
                    window.pJSDom[0].pJS.particles.line_linked.color = "#a7d9ee";
                    window.pJSDom[0].pJS.fn.particlesDraw();
                }
            } else if (themeName === 'light') {
                display.style.fontFamily = 'Inter', 'sans-serif';
                historyDisplay.style.fontFamily = 'Inter', 'sans-serif';
                // Adjust particle color for light theme
                if (window.pJSDom && window.pJSDom[0]) {
                    window.pJSDom[0].pJS.particles.color.value = "#555555"; // Darker gray for light
                    window.pJSDom[0].pJS.particles.line_linked.color = "#555555";
                    window.pJSDom[0].pJS.fn.particlesDraw();
                }
            } else { // Dark theme
                display.style.fontFamily = 'Inter', 'sans-serif';
                historyDisplay.style.fontFamily = 'Inter', 'sans-serif';
                // Adjust particle color for dark theme
                if (window.pJSDom && window.pJSDom[0]) {
                    window.pJSDom[0].pJS.particles.color.value = "#ffffff"; // White for dark
                    window.pJSDom[0].pJS.particles.line_linked.color = "#ffffff";
                    window.pJSDom[0].pJS.fn.particlesDraw();
                }
            }
        }

        // --- Core Calculator Functions ---

        function updateDisplay() {
            display.textContent = formatNumber(currentInput);
            historyDisplay.textContent = `${formatNumber(previousInput)} ${operator}`;
            
            // Animate display on update
            display.classList.remove('result-fade-in');
            void display.offsetWidth; // Trigger reflow
            display.classList.add('result-fade-in');

            // Adjust font size dynamically
            adjustFontSize();
        }
        
        function formatNumber(numStr) {
            if (numStr === '' || numStr === null) return '';
            
            // Ensure numbers like '0.' or '123.' are displayed correctly
            if (numStr.endsWith('.') && numStr.indexOf('.') === numStr.length - 1) {
                return numStr;
            }

            const number = parseFloat(numStr);

            if (isNaN(number)) return numStr; // Return as is for "Error"

            // Limit significant figures for very long numbers to prevent overflow or unnecessary precision
            const maxDisplayLength = 12; // Adjust based on screen size/design
            let formatted = number.toLocaleString('en-US', { maximumFractionDigits: 10 }); // Default
            
            // Handle scientific notation for very large/small numbers more intelligently
            if (Math.abs(number) >= 1e12 || (Math.abs(number) < 1e-9 && number !== 0)) {
                formatted = number.toExponential(7); // Use more precision for scientific
            } else if (formatted.length > maxDisplayLength) {
                // If the formatted string is too long, try toLocaleString with fewer fractions
                formatted = number.toLocaleString('en-US', { maximumFractionDigits: maxDisplayLength - String(Math.floor(number)).length - (number < 0 ? 1 : 0) });
                // Fallback to exponential if it's still too long or problematic
                if (formatted.length > maxDisplayLength || formatted.includes('e')) {
                     formatted = number.toPrecision(10); // Attempt to fit without exponential unless necessary
                }
            }
            
            // Re-add trailing dot if original input had it
            if (numStr.endsWith('.') && !formatted.includes('.')) {
                formatted += '.';
            }

            return formatted;
        }


        // Dynamic font size adjustment for display
        function adjustFontSize() {
            const displayLength = display.textContent.length;
            display.classList.remove('text-5xl', 'text-fit-sm', 'text-fit-md', 'text-fit-lg'); // Remove all first

            if (displayLength > 16) { // For extremely long results
                display.classList.add('text-fit-sm');
            } else if (displayLength > 12) { // For very long results
                display.classList.add('text-fit-md');
            } else if (displayLength > 9) { // For long results
                display.classList.add('text-fit-lg');
            } else { // Default size
                display.classList.add('text-5xl');
            }
        }


        function clearDisplay() {
            currentInput = '0';
            operator = '';
            previousInput = '';
            shouldResetDisplay = false;
            updateDisplay();
            // Remove screen glow and error shake
            screenContainer.classList.remove('screen-glow', 'error-shake', 'screen-subtle-glow');
            deactivateOperatorButton(); // Clear active operator styling
        }

        function deleteLast() {
            if (shouldResetDisplay) {
                clearDisplay();
                return;
            }
            if (currentInput.length > 1) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            updateDisplay();
            triggerSubtleScreenGlow(); // Subtle glow on input change
        }

        function appendNumber(number) {
            if (currentInput === '0' && number !== '.') {
                currentInput = number;
            } else if (number === '.' && currentInput.includes('.')) {
                return; // Prevent multiple decimals
            } else {
                if(shouldResetDisplay) {
                    currentInput = number;
                    shouldResetDisplay = false;
                } else {
                    currentInput += number;
                }
            }
            updateDisplay();
            triggerSubtleScreenGlow(); // Subtle glow on input change
            deactivateOperatorButton(); // Deactivate operator highlight when number is typed
        }

        function appendOperator(op) {
            if (operator && !shouldResetDisplay) {
                calculateResult();
            }
            previousInput = currentInput;
            operator = op;
            shouldResetDisplay = true;
            updateDisplay();
            triggerSubtleScreenGlow(); // Subtle glow on input change
            highlightOperatorButton(op); // Highlight the pressed operator
        }

        function calculateResult() {
            if (!operator || !previousInput) return;

            let result;
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);

            if (isNaN(prev) || isNaN(current)) {
                showError("Error");
                return;
            }
            
            // Perform calculation based on operator
            try {
                switch (operator) {
                    case '+': result = prev + current; break;
                    case '-': result = prev - current; break;
                    case '*': result = prev * current; break;
                    case '/': 
                        if (current === 0) {
                            showError("Div by zero");
                            return;
                        }
                        result = prev / current;
                        break;
                    case '%': result = prev % current; break;
                    case '^': result = Math.pow(prev, current); break; // For x^y (power)
                    default: return;
                }
            } catch (e) {
                showError("Error");
                console.error("Calculation error:", e);
                return;
            }
            
            // Handle floating point precision issues
            result = parseFloat(result.toPrecision(12)); // Limit precision for display

            // Update state with result
            currentInput = String(result);
            operator = '';
            previousInput = '';
            shouldResetDisplay = true;
            updateDisplay();
            
            // Add screen glow animation on result
            triggerResultScreenGlow();
            deactivateOperatorButton(); // Clear active operator styling
        }

        // --- Scientific Functions ---
        function performScientific(func) {
            let value = parseFloat(currentInput);
            let originalHistory = `${formatNumber(currentInput)}`; // Capture current display as history for scientific ops

            if (isNaN(value) && func !== 'pi') {
                showError("Error");
                return;
            }

            let result;
            try {
                switch (func) {
                    case 'sin':
                        originalHistory = `sin(${originalHistory})`;
                        result = Math.sin(value * (Math.PI / 180)); // Convert degrees to radians
                        break;
                    case 'cos':
                        originalHistory = `cos(${originalHistory})`;
                        result = Math.cos(value * (Math.PI / 180)); // Convert degrees to radians
                        break;
                    case 'tan':
                        originalHistory = `tan(${originalHistory})`;
                        result = Math.tan(value * (Math.PI / 180)); // Convert degrees to radians
                        break;
                    case 'sqrt':
                        if (value < 0) {
                            showError("Invalid input"); // Cannot take sqrt of negative number
                            return;
                        }
                        originalHistory = `√(${originalHistory})`;
                        result = Math.sqrt(value);
                        break;
                    case 'log':
                        if (value <= 0) {
                            showError("Invalid input"); // Cannot take log of non-positive number
                            return;
                        }
                        originalHistory = `log(${originalHistory})`;
                        result = Math.log10(value); // Base 10 logarithm
                        break;
                    case 'ln': // Natural Logarithm
                        if (value <= 0) {
                            showError("Invalid input"); 
                            return;
                        }
                        originalHistory = `ln(${originalHistory})`;
                        result = Math.log(value);
                        break;
                    case 'pi':
                        result = Math.PI;
                        originalHistory = 'π'; // No input value needed for pi
                        break;
                    case 'exp': // e^x
                        originalHistory = `e^(${originalHistory})`;
                        result = Math.exp(value);
                        break;
                    case 'pow2': // x^2
                        originalHistory = `(${originalHistory})²`;
                        result = Math.pow(value, 2);
                        break;
                    case 'pow': // x^y, prepares for next number as exponent
                        previousInput = currentInput;
                        operator = '^'; // Custom operator for power
                        shouldResetDisplay = true;
                        updateDisplay();
                        highlightOperatorButton('^'); // Highlight the power button
                        return; // Don't set currentInput immediately
                    case 'fact': // Factorial (n!)
                        if (value < 0 || !Number.isInteger(value)) {
                            showError("Invalid input"); // Factorial only for non-negative integers
                            return;
                        }
                        originalHistory = `(${originalHistory})!`;
                        result = factorial(value);
                        break;
                    default:
                        return;
                }
            } catch (e) {
                showError("Error");
                console.error("Scientific calculation error:", e);
                return;
            }

            // Handle floating point precision issues
            result = parseFloat(result.toPrecision(12)); // Limit precision for display

            currentInput = String(result);
            historyDisplay.textContent = originalHistory + ' ='; // Show function in history
            shouldResetDisplay = true; // After scientific operation, next number should reset display
            operator = ''; // Clear operator as this is a single-operand function
            updateDisplay(); // This will display currentInput

            // Add screen glow animation on scientific result
            triggerResultScreenGlow();
            deactivateOperatorButton(); // Clear active operator styling
        }

        // Helper function for factorial
        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            if (n < 0) return NaN;
            let res = 1;
            for (let i = 2; i <= n; i++) {
                if (res > Number.MAX_SAFE_INTEGER / i) { // Prevent overflow for large numbers
                    return Infinity;
                }
                res *= i;
            }
            return res;
        }

        // --- UI Feedback & Animations ---
        function triggerResultScreenGlow() {
            screenContainer.classList.remove('screen-glow');
            void screenContainer.offsetWidth; // Trigger reflow
            screenContainer.classList.add('screen-glow');
            setTimeout(() => {
                screenContainer.classList.remove('screen-glow');
            }, 800); // Match animation duration
        }

        function triggerSubtleScreenGlow() {
            screenContainer.classList.remove('screen-subtle-glow');
            void screenContainer.offsetWidth; // Trigger reflow
            screenContainer.classList.add('screen-subtle-glow');
            setTimeout(() => {
                screenContainer.classList.remove('screen-subtle-glow');
            }, 200); // Shorter duration for subtle glow
        }

        function showError(message) {
            display.textContent = message;
            historyDisplay.textContent = "";
            screenContainer.classList.add('error-shake'); // Add shake animation
            setTimeout(() => {
                screenContainer.classList.remove('error-shake');
                clearDisplay(); // Clear after error message
            }, 1500);
        }
        
        // --- Operator Button Highlight ---
        function highlightOperatorButton(op) {
            deactivateOperatorButton(); // Deactivate any previously active operator
            const operatorButtons = document.querySelectorAll('.btn-operator');
            operatorButtons.forEach(button => {
                if (button.textContent === opMapping[op]) { // Use a mapping for visual text vs internal operator
                    button.classList.add('active-operator');
                }
            });
            // Handle scientific 'pow' button separately if it acts as an operator
            if (op === '^') {
                 document.querySelector('[onclick="performScientific(\'pow\')"]').classList.add('active-operator');
            }
        }

        function deactivateOperatorButton() {
            document.querySelectorAll('.btn-operator, .btn-scientific').forEach(button => {
                button.classList.remove('active-operator');
            });
        }

        // Mapping for visual operator text to internal operator key
        const opMapping = {
            '+': '+',
            '-': '−', // Unicode minus sign
            '*': '×', // Unicode multiplication sign
            '/': '÷', // Unicode division sign
            '%': '%',
            '^': 'xʸ' // For the scientific power button
        };


        // --- Copy to Clipboard Functionality ---
        copyBtn.addEventListener('click', async () => {
            const textToCopy = display.textContent;
            try {
                await navigator.clipboard.writeText(textToCopy);
                copyText.textContent = 'Copied!';
                setTimeout(() => {
                    copyText.textContent = 'Copy';
                }, 1500);
            } catch (err) {
                console.error('Failed to copy: ', err);
                copyText.textContent = 'Failed!';
                setTimeout(() => {
                    copyText.textContent = 'Copy';
                }, 1500);
            }
        });
        
        // Show copy button on hover over screen container
        screenContainer.addEventListener('mouseenter', () => {
            copyBtn.style.opacity = '1';
        });
        screenContainer.addEventListener('mouseleave', () => {
            copyBtn.style.opacity = '0';
        });


        // --- Keyboard Support ---
        
        document.addEventListener('keydown', (event) => {
            const key = event.key;

            if (key >= '0' && key <= '9') {
                appendNumber(key);
            } else if (key === '.') {
                appendNumber('.');
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault(); // Prevent default Enter key behavior (e.g., submitting forms)
                calculateResult();
            } else if (key === 'Backspace') {
                deleteLast();
            } else if (key === 'Escape' || key.toLowerCase() === 'c') {
                clearDisplay();
            } else if (['+', '-', '*', '/'].includes(key)) {
                appendOperator(key);
            } else if (key === '%') {
                appendOperator('%');
            } else if (key === '^') { // For x^y via keyboard
                performScientific('pow');
            } else if (key.toLowerCase() === 's' && !event.altKey && !event.ctrlKey) { // 's' for sin
                performScientific('sin');
            } else if (key.toLowerCase() === 'c' && event.altKey) { // Alt+C for cos to avoid conflict with 'C' for clear
                performScientific('cos');
            } else if (key.toLowerCase() === 't') { // 't' for tan
                performScientific('tan');
            } else if (key === 'r') { // 'r' for square root
                performScientific('sqrt');
            } else if (key.toLowerCase() === 'p') { // 'p' for pi
                performScientific('pi');
            } else if (key.toLowerCase() === 'l' && !event.altKey && !event.ctrlKey) { // 'l' for log
                performScientific('log');
            } else if (key.toLowerCase() === 'e' && !event.altKey && !event.ctrlKey) { // 'e' for e^x
                performScientific('exp');
            } else if (key === '!') { // '!' for factorial
                performScientific('fact');
            } else if (key.toLowerCase() === 'n' && event.altKey) { // Alt+N for natural log (ln)
                performScientific('ln');
            }
        });


        // Initial display update
        updateDisplay();
        // Set initial particle color based on default theme
        setTheme('dark'); 

    </script>
</body>
</html>